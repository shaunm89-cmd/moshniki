<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moshniki’s Cashflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --sidebar: #020617;
      --card: #1e293b;
      --accent: #38bdf8;
      --success: #10b981;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: #334155;
    }

    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; }

    /* LAYOUT */
    .app { display: grid; grid-template-columns: 280px 1fr; height: 100vh; }
    
    /* SIDEBAR (Timeline) */
    aside { background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .logo-area { padding: 20px; border-bottom: 1px solid var(--border); }
    .logo-area h1 { margin: 0; font-size: 18px; color: var(--accent); }
    
    .timeline { flex: 1; overflow-y: auto; padding: 10px; }
    .timeline-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-muted);
      border: 1px solid transparent;
    }
    .timeline-item:hover { background: #1e293b88; }
    .timeline-item.active { background: var(--accent); color: #000; font-weight: bold; }
    .timeline-item.completed { opacity: 0.5; text-decoration: line-through; }

    .history-section { padding: 20px; border-top: 1px solid var(--border); background: #0f172a; }

    /* MAIN CONTENT */
    main { padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

    /* CARDS */
    .top-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .card h3 { margin: 0 0 10px; font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .big-num { font-size: 28px; font-weight: 700; }
    .sub-num { font-size: 13px; color: var(--text-muted); margin-top: 5px; }

    /* SPLIT VIEW */
    .split-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

    /* BILL ROWS */
    .bill-row { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; align-items: center; }
    
    /* INPUTS */
    input, select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; width: 100%; box-sizing: border-box;}
    
    /* BUTTONS */
    .btn { background: var(--accent); color: black; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-complete { background: var(--success); color: white; }

    /* HELPERS */
    .badge { background: #334155; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px; }
    .saving-breakdown { font-size: 14px; color: var(--accent); margin-top: 5px; }
  </style>
</head>
<body>

<div class="app">
  <aside>
    <div class="logo-area">
      <h1>Moshniki Cashflow</h1>
      <button id="authBtn" class="btn" style="margin-top:10px; font-size:12px; padding:8px;">Sign In</button>
    </div>
    
    <div style="padding:10px 20px 0; color:var(--text-muted); font-size:12px; font-weight:bold;">FUTURE WEEKS</div>
    <div class="timeline" id="timelineList">
      </div>

    <div class="history-section">
      <h3 style="margin:0 0 10px; font-size:12px; color:var(--text-muted)">HISTORY TOTALS</h3>
      <div style="font-size:13px; display:flex; justify-content:space-between; margin-bottom:5px;">
        <span>Paid to Strata:</span>
        <span id="histStrata" style="color:var(--accent)">$0</span>
      </div>
      <div style="font-size:13px; display:flex; justify-content:space-between;">
        <span>Total Saved:</span>
        <span id="histSaved" style="color:var(--success)">$0</span>
      </div>
    </div>
  </aside>

  <main>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 id="viewTitle" style="margin:0">Planning Mode</h2>
      <div style="text-align:right">
        <label style="font-size:12px; color:var(--text-muted)">Projected Bank Balance by this date</label>
        <div id="accumulatedSavings" style="font-size:24px; color:var(--success); font-weight:bold;">$0.00</div>
      </div>
    </div>

    <div class="top-stats">
      <div class="card">
        <h3>Income This Week</h3>
        <input type="number" id="weekIncome" value="0" onchange="updateCalculations()">
      </div>
      <div class="card">
        <h3>Leftover Cash</h3>
        <div class="big-num" id="weekLeftover">$0</div>
        <div class="sub-text">Safe to spend</div>
      </div>
      <div class="card">
        <h3>To Save This Week</h3>
        <div class="big-num" id="weekSavingsReq">$0</div>
        <div class="sub-text">Includes bill set-asides</div>
      </div>
    </div>

    <div class="split-layout">
      <div class="card">
        <h3>Expenses & Savings for <span id="currentDateLabel">...</span></h3>
        <div id="billContainer"></div>
        <button class="btn btn-outline" onclick="addBill()">+ Add Expense</button>
      </div>

      <div style="display:flex; flex-direction:column; gap:20px;">
        
        <div class="card" style="border-color: var(--accent);">
          <h3 style="color:var(--accent)">Bill Splitter</h3>
          <p style="font-size:13px; color:var(--text-muted); margin-bottom:15px;">
            Here is exactly what you need to put away <b>this pay cycle</b> to cover your larger bills.
          </p>
          <div id="savingsBreakdownList" style="font-size:13px; display:flex; flex-direction:column; gap:8px;"></div>
        </div>

        <div class="card">
          <h3>Settings</h3>
          <label style="font-size:12px; color:var(--text-muted)">Next Pay Date</label>
          <input type="date" id="payDate" onchange="renderTimeline()">
          
          <label style="font-size:12px; color:var(--text-muted); margin-top:10px; display:block">Frequency</label>
          <select id="frequency" onchange="renderTimeline()">
            <option value="weekly">Weekly</option>
            <option value="fortnightly">Fortnightly</option>
          </select>

          <button class="btn" onclick="saveTemplate()" style="margin-top:15px;">Save Template</button>
        </div>

        <button class="btn btn-complete" onclick="completeWeek()">✔ Mark Week Complete</button>
      </div>
    </div>
  </main>
</div>

<script>
  // --- FIREBASE CONFIG (Put your keys here) ---
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let userId = null;

  // --- STATE ---
  let template = { 
    income: 0, 
    bills: [],
    payDate: new Date().toISOString().split('T')[0],
    frequency: 'weekly' 
  };
  
  let history = []; // Stores completed weeks
  let selectedOffset = 0; // 0 = next pay, 1 = pay after that...

  // --- AUTH ---
  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      document.getElementById("authBtn").innerText = "Signed In";
      loadData();
    }
  });
  document.getElementById("authBtn").onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

  // --- CORE LOGIC ---

  function addBill(name="", amount=0, freq="weekly") {
    template.bills.push({ name, amount, freq });
    renderBills();
  }

  // 1. Render the Bill Inputs
  function renderBills() {
    const container = document.getElementById("billContainer");
    container.innerHTML = "";
    
    template.bills.forEach((bill, i) => {
      const div = document.createElement("div");
      div.className = "bill-row";
      div.innerHTML = `
        <input value="${bill.name}" placeholder="Name (e.g. Strata)" onchange="template.bills[${i}].name=this.value; updateCalculations()">
        <input type="number" value="${bill.amount}" placeholder="$" onchange="template.bills[${i}].amount=+this.value; updateCalculations()">
        <select onchange="template.bills[${i}].freq=this.value; updateCalculations()">
          <option value="weekly" ${bill.freq==='weekly'?'selected':''}>Weekly</option>
          <option value="fortnightly" ${bill.freq==='fortnightly'?'selected':''}>Fortnightly</option>
          <option value="monthly" ${bill.freq==='monthly'?'selected':''}>Monthly</option>
          <option value="quarterly" ${bill.freq==='quarterly'?'selected':''}>Quarterly</option>
        </select>
        <button style="color:red; background:none; border:none; cursor:pointer;" onclick="template.bills.splice(${i},1);renderBills()">x</button>
      `;
      container.appendChild(div);
    });
    updateCalculations();
  }

  // 2. The "Brains" - Calculate what to save THIS week based on Bill Freq vs Pay Freq
  function updateCalculations() {
    const payFreq = document.getElementById("frequency").value; // 'weekly' or 'fortnightly'
    const income = parseFloat(document.getElementById("weekIncome").value) || 0;
    template.income = income;

    let totalRequiredSavings = 0;
    let savingsListHTML = "";

    template.bills.forEach(bill => {
      let costPerPay = 0;
      let note = "";

      // LOGIC: Convert Bill Freq to Annual, then divide by Pay Freq
      const annualCost = getAnnualCost(bill.amount, bill.freq);
      const paysPerYear = payFreq === 'weekly' ? 52 : 26;
      costPerPay = annualCost / paysPerYear;

      // Formatting logic for the "Bill Splitter" Box
      if(bill.freq !== payFreq) {
        note = `(Save <b>$${costPerPay.toFixed(2)}</b> / pay)`;
      } else {
        note = `(Pay full amount)`;
      }
      
      totalRequiredSavings += costPerPay;
      
      if(costPerPay > 0) {
        savingsListHTML += `
          <div style="display:flex; justify-content:space-between; border-bottom:1px solid #334155; padding-bottom:4px;">
            <span>${bill.name}</span>
            <span>$${costPerPay.toFixed(2)}</span>
          </div>
        `;
      }
    });

    const leftover = income - totalRequiredSavings;

    // Update UI
    document.getElementById("weekLeftover").innerText = "$" + leftover.toFixed(2);
    document.getElementById("weekSavingsReq").innerText = "$" + totalRequiredSavings.toFixed(2);
    document.getElementById("savingsBreakdownList").innerHTML = savingsListHTML;
    
    // Update Forecast based on selected offset
    updateForecast(totalRequiredSavings);
  }

  function getAnnualCost(amount, freq) {
    if(freq === 'weekly') return amount * 52;
    if(freq === 'fortnightly') return amount * 26;
    if(freq === 'monthly') return amount * 12;
    if(freq === 'quarterly') return amount * 4;
    return 0;
  }

  // 3. Render the Left Sidebar (Timeline)
  function renderTimeline() {
    const list = document.getElementById("timelineList");
    list.innerHTML = "";
    
    const startStr = document.getElementById("payDate").value;
    if(!startStr) return;

    const startDate = new Date(startStr);
    const freq = document.getElementById("frequency").value;
    const daysToAdd = freq === 'weekly' ? 7 : 14;

    for(let i=0; i<12; i++) {
      let d = new Date(startDate);
      d.setDate(startDate.getDate() + (i * daysToAdd));
      
      const dateStr = d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
      
      const div = document.createElement("div");
      div.className = `timeline-item ${i === selectedOffset ? 'active' : ''}`;
      div.innerHTML = `<span>Week ${i+1}</span> <span>${dateStr}</span>`;
      div.onclick = () => {
        selectedOffset = i;
        renderTimeline(); // re-render to update active class
        document.getElementById("viewTitle").innerText = "Planning: " + dateStr;
        document.getElementById("currentDateLabel").innerText = dateStr;
        updateCalculations();
      };
      list.appendChild(div);
    }
    
    // Set initial Label
    if(selectedOffset === 0) {
        const d = new Date(startDate);
        const s = d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        document.getElementById("viewTitle").innerText = "Next Pay: " + s;
        document.getElementById("currentDateLabel").innerText = s;
    }
  }

  // 4. Forecast Logic
  function updateForecast(weeklySavings) {
    // Simple logic: If I save $X every week, how much will I have by selected week?
    // In a real app, this would query accumulated history + future projections
    // Here we project: (Current History Total) + (Weekly Savings * (selectedOffset + 1))
    
    const historyTotal = history.reduce((acc, week) => acc + (week.saved || 0), 0);
    const futureAccumulation = weeklySavings * (selectedOffset + 1);
    const total = historyTotal + futureAccumulation;

    document.getElementById("accumulatedSavings").innerText = "$" + total.toFixed(2);
  }

  // 5. Complete Week Logic
  function completeWeek() {
    if(!confirm("Mark this week as done? This will add totals to your history.")) return;
    
    const income = template.income;
    const strataBill = template.bills.find(b => b.name.toLowerCase().includes('strata'));
    const saved = parseFloat(document.getElementById("weekSavingsReq").innerText.replace('$',''));

    // Save to History
    const entry = {
      date: new Date().toISOString(),
      income: income,
      saved: saved,
      paidStrata: strataBill ? (strataBill.amount / (strataBill.freq === 'weekly'?1:4)) : 0 // Rough logic, can be refined
    };

    if(userId) {
      db.collection("users").doc(userId).collection("history").add(entry).then(() => {
        alert("Week saved!");
        loadHistory();
      });
    }
  }

  // 6. Save/Load
  function saveTemplate() {
    if(!userId) return;
    template.payDate = document.getElementById("payDate").value;
    template.frequency = document.getElementById("frequency").value;
    db.collection("users").doc(userId).set(template);
  }

  function loadData() {
    // Load Template
    db.collection("users").doc(userId).get().then(doc => {
      if(doc.exists) {
        const d = doc.data();
        template = d;
        document.getElementById("weekIncome").value = template.income || 0;
        document.getElementById("payDate").value = template.payDate || new Date().toISOString().split('T')[0];
        document.getElementById("frequency").value = template.frequency || 'weekly';
        renderBills();
        renderTimeline();
      }
    });
    loadHistory();
  }

  function loadHistory() {
    db.collection("users").doc(userId).collection("history").get().then(snap => {
      history = [];
      let totalStrata = 0;
      let totalSaved = 0;
      
      snap.forEach(doc => {
        const data = doc.data();
        history.push(data);
        // Simple string match for "Strata" tracking
        // In real app, we'd look at specific bill IDs
        if(data.paidStrata) totalStrata += data.paidStrata; 
        totalSaved += (data.saved || 0);
      });

      document.getElementById("histStrata").innerText = "$" + totalStrata.toFixed(0);
      document.getElementById("histSaved").innerText = "$" + totalSaved.toFixed(0);
    });
  }

</script>
</body>
</html>
