<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moshniki • Budget</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#121a2a; --panel2:#0f1626; --text:#e8eefc; --muted:#9fb0d0;
      --line:#223152; --good:#37d67a; --bad:#ff5c70; --warn:#ffcc66; --accent:#6aa9ff;
      --chip:#17223a;
      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{margin:0;background:linear-gradient(160deg,#070a11 0%, #0b1020 55%, #090d17 100%);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .title{display:flex;flex-direction:column;gap:4px}
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:10px 12px;border-radius:999px; cursor:pointer; font-weight:700; font-size:13px;
    }
    .tab.active{background:rgba(106,169,255,.18); border-color:rgba(106,169,255,.6);}
    .grid{display:grid;grid-template-columns:1.4fr .6fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid rgba(34,49,82,.6);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .card .hd h2{margin:0;font-size:16px}
    .card .bd{padding:14px}
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800; font-size:13px;
    }
    .btn.primary{border-color:rgba(106,169,255,.7); background:rgba(106,169,255,.15)}
    .btn.danger{border-color:rgba(255,92,112,.7); background:rgba(255,92,112,.10)}
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{background:var(--chip);border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    input, select{
      background:#0b1222; color:var(--text); border:1px solid var(--line);
      padding:10px 10px; border-radius:12px; outline:none; width:100%;
    }
    input:focus, select:focus{border-color:rgba(106,169,255,.7); box-shadow:0 0 0 4px rgba(106,169,255,.12)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 540px){ .two{grid-template-columns:1fr} }
    table{width:100%;border-collapse:collapse}
    th, td{border-bottom:1px solid rgba(34,49,82,.5);padding:10px 8px;text-align:left;vertical-align:middle}
    th{color:var(--muted);font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:.7px}
    .money{text-align:right;font-variant-numeric: tabular-nums;}
    .muted{color:var(--muted)}
    .pos{color:var(--good);font-weight:900}
    .neg{color:var(--bad);font-weight:900}
    .warn{color:var(--warn);font-weight:900}
    .hidden{display:none}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi .box{padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.15)}
    .kpi .lbl{color:var(--muted);font-size:12px;font-weight:800}
    .kpi .val{font-size:18px;font-weight:950;margin-top:6px}
    .list{display:flex;flex-direction:column;gap:10px}
    .note{color:var(--muted);font-size:12px;line-height:1.4}
    .hr{height:1px;background:rgba(34,49,82,.6);margin:12px 0}
    .pillbar{height:10px;background:rgba(255,255,255,.06);border:1px solid rgba(34,49,82,.6);border-radius:999px;overflow:hidden}
    .pillbar > div{height:100%;background:rgba(106,169,255,.6)}
    .right{justify-content:flex-end}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Moshniki • Personal Budget</h1>
        <div class="sub">Local-only (saved in this browser). No logins, no servers.</div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="budget">Weekly Budget</button>
        <button class="tab" data-tab="debts">Debt Tracker</button>
        <button class="tab" data-tab="history">Archived Weeks</button>
        <button class="tab" data-tab="settings">Settings</button>
      </div>
    </header>

    <!-- BUDGET -->
    <section id="tab-budget">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Current Week</h2>
            <div class="row">
              <span class="chip" id="weekLabel">—</span>
              <button class="btn small" id="prevWeekBtn">◀</button>
              <button class="btn small" id="nextWeekBtn">▶</button>
              <button class="btn primary" id="addWeekBtn">+ New Week</button>
              <button class="btn" id="completeWeekBtn">Complete Week</button>
            </div>
          </div>
          <div class="bd">
            <div class="kpi">
              <div class="box">
                <div class="lbl">Income</div>
                <div class="val" id="kpiIncome">$0.00</div>
              </div>
              <div class="box">
                <div class="lbl">Difference</div>
                <div class="val" id="kpiDiff">$0.00</div>
              </div>
              <div class="box">
                <div class="lbl">Bills + Spending</div>
                <div class="val" id="kpiOut">$0.00</div>
              </div>
              <div class="box">
                <div class="lbl">Savings</div>
                <div class="val" id="kpiSavings">$0.00</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="two">
              <div>
                <label class="muted">Pay day label (e.g. 7-Jan)</label>
                <input id="paydayInput" placeholder="7-Jan">
              </div>
              <div>
                <label class="muted">Income</label>
                <input id="incomeInput" type="number" step="0.01" min="0">
              </div>
              <div>
                <label class="muted">Savings</label>
                <input id="savingsInput" type="number" step="0.01" min="0">
              </div>
              <div>
                <label class="muted">Groceries</label>
                <input id="groceriesInput" type="number" step="0.01" min="0">
              </div>
              <div>
                <label class="muted">Guilt-free spending</label>
                <input id="guiltInput" type="number" step="0.01" min="0">
              </div>
              <div>
                <label class="muted">Quick note (optional)</label>
                <input id="noteInput" placeholder="Birthday, bigger power bill, etc">
              </div>
            </div>

            <div class="hr"></div>

            <div class="row" style="justify-content:space-between;align-items:flex-start">
              <div style="flex:1;min-width:280px">
                <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px">Utilities / Bills</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th class="money">Amount</th>
                      <th class="money nowrap">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="billsBody"></tbody>
                </table>
                <div class="row" style="margin-top:10px">
                  <input id="newBillName" placeholder="Add bill name (e.g. Strata Rates)">
                  <input id="newBillAmt" type="number" step="0.01" min="0" placeholder="0.00" style="max-width:180px">
                  <button class="btn primary" id="addBillBtn">Add</button>
                </div>
              </div>

              <div style="flex:0.9;min-width:260px">
                <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px">Breakdown</h3>
                <div class="list">
                  <div class="box" style="padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.15)">
                    <div class="row" style="justify-content:space-between">
                      <div class="muted">Bills total</div>
                      <div class="money" id="billsTotal">$0.00</div>
                    </div>
                    <div class="row" style="justify-content:space-between;margin-top:8px">
                      <div class="muted">Groceries + Guilt-free</div>
                      <div class="money" id="spendTotal">$0.00</div>
                    </div>
                    <div class="row" style="justify-content:space-between;margin-top:8px">
                      <div class="muted">Savings</div>
                      <div class="money" id="savingsTotal">$0.00</div>
                    </div>
                    <div class="hr"></div>
                    <div class="row" style="justify-content:space-between">
                      <div class="muted">Leftover / Shortfall</div>
                      <div class="money" id="diffLine">$0.00</div>
                    </div>
                    <div class="note" style="margin-top:8px">
                      Tip: Instead of deleting columns like Excel, hit <b>Complete Week</b> to archive it and start a clean one.
                    </div>
                  </div>

                  <div class="box" style="padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.15)">
                    <div class="muted" style="font-weight:900;margin-bottom:6px">Week note</div>
                    <div id="weekNote" class="note">—</div>
                  </div>

                  <button class="btn danger" id="resetWeekBtn">Reset this week</button>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Quick Actions</h2>
          </div>
          <div class="bd">
            <div class="list">
              <button class="btn" id="clonePrevWeekBtn">Clone previous week (copy bills + defaults)</button>
              <button class="btn" id="exportBtn">Export data (JSON)</button>
              <label class="btn" style="display:block;text-align:center;cursor:pointer">
                Import data (JSON)
                <input id="importFile" type="file" accept="application/json" style="display:none">
              </label>
              <div class="hr"></div>
              <div class="note">
                Everything is saved only in <b>this browser</b>. If you switch devices/browsers, export + import.
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- DEBTS -->
    <section id="tab-debts" class="hidden">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Debt Tracker</h2>
            <div class="row">
              <button class="btn primary" id="addDebtBtn">+ Add Debt</button>
            </div>
          </div>
          <div class="bd">
            <div id="debtsList" class="list"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Payoff Comparison</h2>
          </div>
          <div class="bd">
            <div class="note">
              Pick a debt on the left. This shows how long it takes with your chosen payment vs a “minimum payment”.
              (You can set the minimum manually per debt.)
            </div>
            <div class="hr"></div>
            <div id="compareBox" class="hidden">
              <div class="kpi">
                <div class="box">
                  <div class="lbl">Your payment payoff</div>
                  <div class="val" id="yourPayoff">—</div>
                </div>
                <div class="box">
                  <div class="lbl">Minimum payment payoff</div>
                  <div class="val" id="minPayoff">—</div>
                </div>
                <div class="box">
                  <div class="lbl">Interest (your payment)</div>
                  <div class="val" id="yourInterest">—</div>
                </div>
                <div class="box">
                  <div class="lbl">Interest (minimum)</div>
                  <div class="val" id="minInterest">—</div>
                </div>
              </div>
              <div class="hr"></div>
              <div class="muted" style="font-weight:900;margin-bottom:8px">Progress bar (rough)</div>
              <div class="pillbar"><div id="progressBar" style="width:0%"></div></div>
              <div class="note" style="margin-top:8px" id="progressNote">—</div>
            </div>
            <div id="compareEmpty" class="note">Select a debt to see comparison.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="tab-history" class="hidden">
      <div class="card">
        <div class="hd">
          <h2>Archived Weeks</h2>
          <div class="row">
            <button class="btn danger" id="clearArchiveBtn">Clear archive</button>
          </div>
        </div>
        <div class="bd">
          <div id="archiveList" class="list"></div>
          <div class="note">Archive is useful because it shows how “random weeks” actually hit you over time.</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="hidden">
      <div class="card">
        <div class="hd">
          <h2>Settings</h2>
        </div>
        <div class="bd">
          <div class="two">
            <div>
              <label class="muted">Default weekly income</label>
              <input id="defaultIncome" type="number" step="0.01" min="0">
            </div>
            <div>
              <label class="muted">Default groceries</label>
              <input id="defaultGroceries" type="number" step="0.01" min="0">
            </div>
            <div>
              <label class="muted">Default guilt-free spending</label>
              <input id="defaultGuilt" type="number" step="0.01" min="0">
            </div>
            <div>
              <label class="muted">Default savings</label>
              <input id="defaultSavings" type="number" step="0.01" min="0">
            </div>
          </div>
          <div class="hr"></div>
          <button class="btn primary" id="saveSettingsBtn">Save settings</button>
        </div>
      </div>
    </section>

  </div>

<script>
  // ===== Utilities =====
  const money = (n) => {
    const x = Number(n || 0);
    return x.toLocaleString(undefined, { style:'currency', currency:'AUD' });
  };
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const uid = () => Math.random().toString(16).slice(2)+Date.now().toString(16);

  // ===== Storage =====
  const KEY = "moshniki_budget_v1";
  const load = () => {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  };
  const save = () => localStorage.setItem(KEY, JSON.stringify(state));

  // ===== Default Template =====
  const defaultBills = [
    { id: uid(), name: "Electricity", amount: 40 },
    { id: uid(), name: "Strata", amount: 85 },
    { id: uid(), name: "Sydney Water", amount: 17.5 },
    { id: uid(), name: "Optus Internet", amount: 47.5 },
    { id: uid(), name: "Mum's Internet & Phone", amount: 27.5 },
    { id: uid(), name: "Council", amount: 45 },
  ];

  const makeWeek = (label="") => ({
    id: uid(),
    paydayLabel: label || "",
    income: 886.12,
    savings: 300,
    groceries: 120,
    guilt: 200,
    note: "",
    bills: JSON.parse(JSON.stringify(defaultBills)),
    createdAt: Date.now(),
  });

  const defaultState = {
    settings: {
      defaultIncome: 886.12,
      defaultGroceries: 120,
      defaultGuilt: 200,
      defaultSavings: 300,
    },
    weeks: [ makeWeek("7-Jan") ],
    currentWeekIndex: 0,
    archive: [],
    debts: [
      // Example empty - user will add their own
    ],
    selectedDebtId: null,
  };

  let state = load() || defaultState;

  // ===== Tabs =====
  const tabButtons = [...document.querySelectorAll(".tab")];
  const tabs = ["budget","debts","history","settings"];
  const showTab = (name) => {
    tabs.forEach(t => {
      document.getElementById("tab-"+t).classList.toggle("hidden", t !== name);
    });
    tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab === name));
  };
  tabButtons.forEach(b => b.addEventListener("click", () => showTab(b.dataset.tab)));

  // ===== Budget UI =====
  const els = {
    weekLabel: document.getElementById("weekLabel"),
    paydayInput: document.getElementById("paydayInput"),
    incomeInput: document.getElementById("incomeInput"),
    savingsInput: document.getElementById("savingsInput"),
    groceriesInput: document.getElementById("groceriesInput"),
    guiltInput: document.getElementById("guiltInput"),
    noteInput: document.getElementById("noteInput"),
    weekNote: document.getElementById("weekNote"),
    billsBody: document.getElementById("billsBody"),
    newBillName: document.getElementById("newBillName"),
    newBillAmt: document.getElementById("newBillAmt"),
    billsTotal: document.getElementById("billsTotal"),
    spendTotal: document.getElementById("spendTotal"),
    savingsTotal: document.getElementById("savingsTotal"),
    diffLine: document.getElementById("diffLine"),
    kpiIncome: document.getElementById("kpiIncome"),
    kpiDiff: document.getElementById("kpiDiff"),
    kpiOut: document.getElementById("kpiOut"),
    kpiSavings: document.getElementById("kpiSavings"),
  };

  const currentWeek = () => state.weeks[state.currentWeekIndex];

  const calcWeek = (w) => {
    const bills = w.bills.reduce((a,b)=>a+Number(b.amount||0),0);
    const spend = Number(w.groceries||0) + Number(w.guilt||0);
    const savings = Number(w.savings||0);
    const out = bills + spend;
    const diff = Number(w.income||0) - savings - out;
    return { bills, spend, savings, out, diff };
  };

  const renderBills = (w) => {
    els.billsBody.innerHTML = "";
    w.bills.forEach(b => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <input data-bill-name="${b.id}" value="${escapeHtml(b.name)}" />
        </td>
        <td class="money">
          <input data-bill-amt="${b.id}" type="number" step="0.01" min="0" value="${Number(b.amount||0)}" />
        </td>
        <td class="money nowrap">
          <button class="btn small danger" data-bill-del="${b.id}">Delete</button>
        </td>
      `;
      els.billsBody.appendChild(tr);
    });

    els.billsBody.querySelectorAll("[data-bill-name]").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const id = e.target.getAttribute("data-bill-name");
        const bill = w.bills.find(x=>x.id===id);
        bill.name = e.target.value;
        save();
      });
    });

    els.billsBody.querySelectorAll("[data-bill-amt]").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const id = e.target.getAttribute("data-bill-amt");
        const bill = w.bills.find(x=>x.id===id);
        bill.amount = Number(e.target.value||0);
        save();
        render();
      });
    });

    els.billsBody.querySelectorAll("[data-bill-del]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const id = e.target.getAttribute("data-bill-del");
        w.bills = w.bills.filter(x=>x.id!==id);
        save();
        render();
      });
    });
  };

  const render = () => {
    const w = currentWeek();
    if (!w) return;

    els.weekLabel.textContent = w.paydayLabel ? `Pay: ${w.paydayLabel}` : "Unnamed week";
    els.paydayInput.value = w.paydayLabel || "";
    els.incomeInput.value = Number(w.income||0);
    els.savingsInput.value = Number(w.savings||0);
    els.groceriesInput.value = Number(w.groceries||0);
    els.guiltInput.value = Number(w.guilt||0);
    els.noteInput.value = w.note || "";
    els.weekNote.textContent = w.note?.trim() ? w.note : "—";

    renderBills(w);

    const c = calcWeek(w);
    els.billsTotal.textContent = money(c.bills);
    els.spendTotal.textContent = money(c.spend);
    els.savingsTotal.textContent = money(c.savings);

    const diffEl = els.diffLine;
    diffEl.textContent = money(c.diff);
    diffEl.className = "money " + (c.diff >= 0 ? "pos" : "neg");

    els.kpiIncome.textContent = money(w.income);
    els.kpiSavings.textContent = money(c.savings);
    els.kpiOut.textContent = money(c.out);
    els.kpiDiff.textContent = money(c.diff);
    els.kpiDiff.className = "val " + (c.diff >= 0 ? "pos" : "neg");

    renderArchive();
    renderDebts();
    renderSettings();
  };

  // Escape helper
  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    })[s]);
  }

  // Inputs binding
  const bindWeekInput = (inputEl, key) => {
    inputEl.addEventListener("input", (e) => {
      const w = currentWeek();
      w[key] = (key === "paydayLabel" || key === "note") ? e.target.value : Number(e.target.value||0);
      save();
      render();
    });
  };
  bindWeekInput(els.paydayInput, "paydayLabel");
  bindWeekInput(els.incomeInput, "income");
  bindWeekInput(els.savingsInput, "savings");
  bindWeekInput(els.groceriesInput, "groceries");
  bindWeekInput(els.guiltInput, "guilt");
  bindWeekInput(els.noteInput, "note");

  // Week navigation
  document.getElementById("prevWeekBtn").addEventListener("click", ()=>{
    state.currentWeekIndex = clamp(state.currentWeekIndex - 1, 0, state.weeks.length - 1);
    save(); render();
  });
  document.getElementById("nextWeekBtn").addEventListener("click", ()=>{
    state.currentWeekIndex = clamp(state.currentWeekIndex + 1, 0, state.weeks.length - 1);
    save(); render();
  });

  // Add week
  document.getElementById("addWeekBtn").addEventListener("click", ()=>{
    const w = makeWeek("");
    // apply defaults
    w.income = state.settings.defaultIncome;
    w.groceries = state.settings.defaultGroceries;
    w.guilt = state.settings.defaultGuilt;
    w.savings = state.settings.defaultSavings;
    state.weeks.push(w);
    state.currentWeekIndex = state.weeks.length - 1;
    save(); render();
  });

  // Clone previous week
  document.getElementById("clonePrevWeekBtn").addEventListener("click", ()=>{
    if (state.weeks.length < 1) return;
    const prev = currentWeek();
    const w = makeWeek("");
    w.income = prev.income;
    w.groceries = prev.groceries;
    w.guilt = prev.guilt;
    w.savings = prev.savings;
    w.bills = JSON.parse(JSON.stringify(prev.bills));
    state.weeks.push(w);
    state.currentWeekIndex = state.weeks.length - 1;
    save(); render();
  });

  // Add bill
  document.getElementById("addBillBtn").addEventListener("click", ()=>{
    const name = els.newBillName.value.trim();
    const amt = Number(els.newBillAmt.value||0);
    if (!name) return;
    currentWeek().bills.push({ id: uid(), name, amount: amt });
    els.newBillName.value = "";
    els.newBillAmt.value = "";
    save(); render();
  });

  // Reset current week
  document.getElementById("resetWeekBtn").addEventListener("click", ()=>{
    const w = currentWeek();
    w.income = state.settings.defaultIncome;
    w.savings = state.settings.defaultSavings;
    w.groceries = state.settings.defaultGroceries;
    w.guilt = state.settings.defaultGuilt;
    w.note = "";
    w.bills = JSON.parse(JSON.stringify(defaultBills));
    save(); render();
  });

  // Complete week -> archive
  document.getElementById("completeWeekBtn").addEventListener("click", ()=>{
    const idx = state.currentWeekIndex;
    const w = state.weeks[idx];
    const summary = { ...w, summary: calcWeek(w), archivedAt: Date.now() };
    state.archive.unshift(summary);

    // replace current week with a fresh week instead of deleting everything
    const nw = makeWeek("");
    nw.income = state.settings.defaultIncome;
    nw.groceries = state.settings.defaultGroceries;
    nw.guilt = state.settings.defaultGuilt;
    nw.savings = state.settings.defaultSavings;
    state.weeks[idx] = nw;

    save(); render();
    showTab("history");
  });

  // Export / Import
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "moshniki-budget-export.json";
    a.click();
    URL.revokeObjectURL(url);
  });
  document.getElementById("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    try{
      const parsed = JSON.parse(text);
      state = parsed;
      save(); render();
      alert("Imported ✅");
    }catch{
      alert("Import failed — invalid JSON");
    }
    e.target.value = "";
  });

  // ===== Archive UI =====
  const archiveList = document.getElementById("archiveList");
  const renderArchive = () => {
    archiveList.innerHTML = "";
    if (!state.archive.length){
      archiveList.innerHTML = `<div class="note">No archived weeks yet. Hit <b>Complete Week</b> to store one.</div>`;
      return;
    }
    state.archive.slice(0, 40).forEach((w)=>{
      const c = w.summary || calcWeek(w);
      const when = new Date(w.archivedAt || w.createdAt || Date.now());
      const el = document.createElement("div");
      el.className = "box";
      el.style.cssText = "padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.15)";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:950">${escapeHtml(w.paydayLabel || "Archived Week")}</div>
            <div class="note">${when.toLocaleString()}</div>
          </div>
          <div class="money ${c.diff>=0?"pos":"neg"}" style="font-size:16px;font-weight:950">${money(c.diff)}</div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="muted">Income</div><div class="money">${money(w.income)}</div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:6px">
          <div class="muted">Bills</div><div class="money">${money(c.bills)}</div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:6px">
          <div class="muted">Spending</div><div class="money">${money(c.spend)}</div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:6px">
          <div class="muted">Savings</div><div class="money">${money(c.savings)}</div>
        </div>
        ${w.note ? `<div class="note" style="margin-top:8px"><b>Note:</b> ${escapeHtml(w.note)}</div>` : ""}
      `;
      archiveList.appendChild(el);
    });
  };
  document.getElementById("clearArchiveBtn").addEventListener("click", ()=>{
    state.archive = [];
    save(); render();
  });

  // ===== Settings UI =====
  const settingsEls = {
    defaultIncome: document.getElementById("defaultIncome"),
    defaultGroceries: document.getElementById("defaultGroceries"),
    defaultGuilt: document.getElementById("defaultGuilt"),
    defaultSavings: document.getElementById("defaultSavings"),
  };
  const renderSettings = () => {
    settingsEls.defaultIncome.value = Number(state.settings.defaultIncome||0);
    settingsEls.defaultGroceries.value = Number(state.settings.defaultGroceries||0);
    settingsEls.defaultGuilt.value = Number(state.settings.defaultGuilt||0);
    settingsEls.defaultSavings.value = Number(state.settings.defaultSavings||0);
  };
  document.getElementById("saveSettingsBtn").addEventListener("click", ()=>{
    state.settings.defaultIncome = Number(settingsEls.defaultIncome.value||0);
    state.settings.defaultGroceries = Number(settingsEls.defaultGroceries.value||0);
    state.settings.defaultGuilt = Number(settingsEls.defaultGuilt.value||0);
    state.settings.defaultSavings = Number(settingsEls.defaultSavings.value||0);
    save(); render();
    alert("Saved ✅");
  });

  // ===== Debt Tracker =====
  const debtsList = document.getElementById("debtsList");
  const compareBox = document.getElementById("compareBox");
  const compareEmpty = document.getElementById("compareEmpty");

  function amortize({principal, annualRate, payment, perYear, maxMonths=1200}) {
    principal = Number(principal||0);
    annualRate = Number(annualRate||0);
    payment = Number(payment||0);
    perYear = Number(perYear||12);

    const r = (annualRate/100) / perYear;
    let bal = principal;
    let totalInterest = 0;
    let n = 0;

    if (principal <= 0) return { months: 0, totalInterest: 0, ok: true };
    if (payment <= 0) return { months: null, totalInterest: null, ok: false, reason: "Payment is $0" };

    // If payment doesn't cover interest, it will never reduce
    const firstInterest = bal * r;
    if (payment <= firstInterest && r > 0) {
      return { months: null, totalInterest: null, ok: false, reason: "Payment too low (doesn't cover interest)" };
    }

    while (bal > 0.01 && n < maxMonths) {
      const interest = bal * r;
      totalInterest += interest;
      const principalPaid = payment - interest;
      bal = bal - principalPaid;
      n++;
      if (bal < 0) bal = 0;
    }

    const months = (perYear === 12) ? n : Math.round((n / perYear) * 12);
    return { months, totalInterest, ok: true };
  }

  function monthsToPretty(months){
    if (months === 0) return "Paid off ✅";
    if (!Number.isFinite(months)) return "—";
    const y = Math.floor(months/12);
    const m = months%12;
    if (y<=0) return `${m} months`;
    if (m===0) return `${y} years`;
    return `${y}y ${m}m`;
  }

  const renderDebts = () => {
    debtsList.innerHTML = "";
    if (!state.debts.length){
      debtsList.innerHTML = `<div class="note">No debts added yet. Hit <b>Add Debt</b> and enter the details.</div>`;
      compareBox.classList.add("hidden");
      compareEmpty.classList.remove("hidden");
      return;
    }

    state.debts.forEach(d => {
      const box = document.createElement("div");
      box.className = "box";
      box.style.cssText = "padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.15)";
      const selected = state.selectedDebtId === d.id;
      box.style.borderColor = selected ? "rgba(106,169,255,.7)" : "var(--line)";

      box.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div style="flex:1">
            <div style="font-weight:950">${escapeHtml(d.name || "Unnamed debt")}</div>
            <div class="note">Balance: <b>${money(d.balance)}</b> • Rate: <b>${Number(d.rate||0).toFixed(2)}%</b></div>
          </div>
          <div class="row right">
            <button class="btn small ${selected ? "primary" : ""}" data-debt-select="${d.id}">${selected ? "Selected" : "Select"}</button>
            <button class="btn small danger" data-debt-del="${d.id}">Delete</button>
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div><label class="muted">Name</label><input data-debt-name="${d.id}" value="${escapeHtml(d.name||"")}"></div>
          <div><label class="muted">Balance</label><input data-debt-bal="${d.id}" type="number" step="0.01" min="0" value="${Number(d.balance||0)}"></div>
          <div><label class="muted">Interest % (APR)</label><input data-debt-rate="${d.id}" type="number" step="0.01" min="0" value="${Number(d.rate||0)}"></div>
          <div>
            <label class="muted">Payment frequency</label>
            <select data-debt-freq="${d.id}">
              <option value="weekly" ${d.freq==="weekly"?"selected":""}>Weekly</option>
              <option value="fortnightly" ${d.freq==="fortnightly"?"selected":""}>Fortnightly</option>
              <option value="monthly" ${d.freq==="monthly"?"selected":""}>Monthly</option>
            </select>
          </div>
          <div><label class="muted">Your payment</label><input data-debt-pay="${d.id}" type="number" step="0.01" min="0" value="${Number(d.payment||0)}"></div>
          <div><label class="muted">Minimum payment (manual)</label><input data-debt-min="${d.id}" type="number" step="0.01" min="0" value="${Number(d.minimum||0)}"></div>
        </div>
      `;
      debtsList.appendChild(box);
    });

    // Bind handlers
    debtsList.querySelectorAll("[data-debt-select]").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        state.selectedDebtId = e.target.getAttribute("data-debt-select");
        save(); render();
      });
    });
    debtsList.querySelectorAll("[data-debt-del]").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        const id = e.target.getAttribute("data-debt-del");
        state.debts = state.debts.filter(x=>x.id!==id);
        if (state.selectedDebtId === id) state.selectedDebtId = null;
        save(); render();
      });
    });

    const bindDebt = (attr, key, parser=(v)=>v) => {
      debtsList.querySelectorAll(`[${attr}]`).forEach(inp=>{
        inp.addEventListener("input",(e)=>{
          const id = e.target.getAttribute(attr);
          const d = state.debts.find(x=>x.id===id);
          d[key] = parser(e.target.value);
          save();
          renderCompare();
        });
        if (attr === "data-debt-freq"){
          inp.addEventListener("change",(e)=>{
            const id = e.target.getAttribute(attr);
            const d = state.debts.find(x=>x.id===id);
            d[key] = e.target.value;
            save();
            renderCompare();
          });
        }
      });
    };

    bindDebt("data-debt-name","name",(v)=>v);
    bindDebt("data-debt-bal","balance",(v)=>Number(v||0));
    bindDebt("data-debt-rate","rate",(v)=>Number(v||0));
    bindDebt("data-debt-freq","freq",(v)=>v);
    bindDebt("data-debt-pay","payment",(v)=>Number(v||0));
    bindDebt("data-debt-min","minimum",(v)=>Number(v||0));

    renderCompare();
  };

  function freqToPerYear(freq){
    if (freq === "weekly") return 52;
    if (freq === "fortnightly") return 26;
    return 12; // monthly
  }

  function renderCompare(){
    const d = state.debts.find(x=>x.id===state.selectedDebtId);
    if (!d){
      compareBox.classList.add("hidden");
      compareEmpty.classList.remove("hidden");
      return;
    }
    compareEmpty.classList.add("hidden");
    compareBox.classList.remove("hidden");

    const perYear = freqToPerYear(d.freq || "monthly");
    const your = amortize({ principal: d.balance, annualRate: d.rate, payment: d.payment, perYear });
    const min = amortize({ principal: d.balance, annualRate: d.rate, payment: d.minimum, perYear });

    const yourPayoffEl = document.getElementById("yourPayoff");
    const minPayoffEl = document.getElementById("minPayoff");
    const yourIntEl = document.getElementById("yourInterest");
    const minIntEl = document.getElementById("minInterest");

    yourPayoffEl.textContent = your.ok ? monthsToPretty(your.months) : your.reason;
    minPayoffEl.textContent  = min.ok  ? monthsToPretty(min.months)  : (d.minimum ? min.reason : "Set a minimum");

    yourIntEl.textContent = your.ok ? money(your.totalInterest) : "—";
    minIntEl.textContent  = min.ok  ? money(min.totalInterest)  : "—";

    // Rough progress bar: show where you are now (always 0% paid if just tracking current balance)
    const pct = 0; // you can extend later by storing originalBalance
    document.getElementById("progressBar").style.width = pct + "%";
    document.getElementById("progressNote").textContent = `Comparison is based on current balance ${money(d.balance)} at ${Number(d.rate||0).toFixed(2)}% APR.`;

    save();
  }

  document.getElementById("addDebtBtn").addEventListener("click", ()=>{
    state.debts.unshift({
      id: uid(),
      name: "",
      balance: 0,
      rate: 0,
      freq: "monthly",
      payment: 0,
      minimum: 0,
      createdAt: Date.now()
    });
    state.selectedDebtId = state.debts[0].id;
    save(); render();
    showTab("debts");
  });

  // Initial render
  render();
  renderCompare();
  showTab("budget");
</script>
</body>
</html>
