<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moshniki’s Cashflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

  <style>
    :root {
      --bg: #0f172a;       /* Deep Navy Background */
      --sidebar: #020617;  /* Darker Sidebar */
      --card: #1e293b;     /* Card Background */
      --accent: #38bdf8;   /* Light Blue Highlight */
      --success: #10b981;  /* Green for Money/Savings */
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: #334155;
    }

    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; }

    /* --- LAYOUT --- */
    .app { display: grid; grid-template-columns: 280px 1fr; height: 100vh; }
    
    /* SIDEBAR (Timeline) */
    aside { background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .logo-area { padding: 20px; border-bottom: 1px solid var(--border); }
    .logo-area h1 { margin: 0; font-size: 18px; color: var(--accent); }
    
    .timeline { flex: 1; overflow-y: auto; padding: 10px; }
    .timeline-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-muted);
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .timeline-item:hover { background: #1e293b88; }
    .timeline-item.active { background: var(--accent); color: #000; font-weight: bold; box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }

    .history-section { padding: 20px; border-top: 1px solid var(--border); background: #0f172a; }

    /* MAIN CONTENT */
    main { padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

    /* CARDS */
    .top-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .card h3 { margin: 0 0 10px; font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .big-num { font-size: 28px; font-weight: 700; }
    .sub-num { font-size: 13px; color: var(--text-muted); margin-top: 5px; }

    /* SPLIT VIEW */
    .split-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    @media (max-width: 900px) { .split-layout { grid-template-columns: 1fr; } .app { grid-template-columns: 1fr; } aside { display:none; } }

    /* BILL ROWS */
    .bill-row { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; align-items: center; }
    
    /* INPUTS */
    input, select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; width: 100%; box-sizing: border-box;}
    input:focus, select:focus { outline: 1px solid var(--accent); border-color: var(--accent); }
    
    /* BUTTONS */
    .btn { background: var(--accent); color: black; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: opacity 0.2s; }
    .btn:hover { opacity: 0.9; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-complete { background: var(--success); color: white; }
    .btn-google { background: white; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px; }

    /* HELPERS */
    .saving-breakdown { font-size: 14px; color: var(--accent); margin-top: 5px; }
  </style>
</head>
<body>

<div class="app">
  <aside>
    <div class="logo-area">
      <h1>Moshniki Cashflow</h1>
      <div id="authContainer" style="margin-top:15px;">
        <button id="authBtn" class="btn btn-google">Sign In</button>
      </div>
    </div>
    
    <div style="padding:15px 20px 5px; color:var(--text-muted); font-size:11px; font-weight:bold; letter-spacing:1px;">FUTURE WEEKS</div>
    <div class="timeline" id="timelineList">
      <div style="padding:20px; text-align:center; color:var(--text-muted); font-size:13px;">Sign in to see timeline</div>
    </div>

    <div class="history-section">
      <h3 style="margin:0 0 10px; font-size:12px; color:var(--text-muted)">HISTORY TOTALS</h3>
      <div style="font-size:13px; display:flex; justify-content:space-between; margin-bottom:8px;">
        <span>Paid to Strata:</span>
        <span id="histStrata" style="color:var(--accent); font-weight:bold;">$0</span>
      </div>
      <div style="font-size:13px; display:flex; justify-content:space-between;">
        <span>Total Saved:</span>
        <span id="histSaved" style="color:var(--success); font-weight:bold;">$0</span>
      </div>
    </div>
  </aside>

  <main>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h2 id="viewTitle" style="margin:0">Planning Mode</h2>
        <div style="font-size:13px; color:var(--text-muted); margin-top:4px;">Manage your cashflow week by week</div>
      </div>
      <div style="text-align:right">
        <label style="font-size:12px; color:var(--text-muted)">Projected Bank Balance</label>
        <div id="accumulatedSavings" style="font-size:24px; color:var(--success); font-weight:bold;">$0.00</div>
      </div>
    </div>

    <div class="top-stats">
      <div class="card">
        <h3>Income This Week</h3>
        <input type="number" id="weekIncome" value="0" onchange="updateCalculations()">
      </div>
      <div class="card">
        <h3>Leftover Cash</h3>
        <div class="big-num" id="weekLeftover">$0</div>
        <div class="sub-text">Safe to spend</div>
      </div>
      <div class="card">
        <h3>To Save This Week</h3>
        <div class="big-num" id="weekSavingsReq">$0</div>
        <div class="sub-text">Includes bill set-asides</div>
      </div>
    </div>

    <div class="split-layout">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
           <h3>Expenses for <span id="currentDateLabel" style="color:white">...</span></h3>
           <span style="font-size:11px; color:var(--text-muted)">Changes auto-save</span>
        </div>
        <div id="billContainer"></div>
        <button class="btn btn-outline" onclick="addBill()">+ Add Expense</button>
      </div>

      <div style="display:flex; flex-direction:column; gap:20px;">
        
        <div class="card" style="border: 1px solid var(--accent);">
          <h3 style="color:var(--accent)">Bill Splitter</h3>
          <p style="font-size:13px; color:var(--text-muted); margin-bottom:15px; line-height:1.4;">
            This calculator tells you exactly what to put away <b>this pay cycle</b> to afford your Monthly/Quarterly bills later.
          </p>
          <div id="savingsBreakdownList" style="font-size:13px; display:flex; flex-direction:column; gap:8px;"></div>
        </div>

        <div class="card">
          <h3>Settings</h3>
          <label style="font-size:12px; color:var(--text-muted)">Next Pay Date</label>
          <input type="date" id="payDate" onchange="renderTimeline(); saveTemplate();"/>
          
          <label style="font-size:12px; color:var(--text-muted); margin-top:10px; display:block">Frequency</label>
          <select id="frequency" onchange="renderTimeline(); saveTemplate();">
            <option value="weekly">Weekly</option>
            <option value="fortnightly">Fortnightly</option>
          </select>
        </div>

        <button class="btn btn-complete" onclick="completeWeek()">✔ Mark Week Complete</button>
      </div>
    </div>
  </main>
</div>

<script>
  // --- 1. FIREBASE CONFIG (YOUR REAL KEYS) ---
  const firebaseConfig = {
    apiKey: "AIzaSyA5No9QeHpYwJDblMFat_cK2gyVm_K1RtE",
    authDomain: "moshniki.firebaseapp.com",
    projectId: "moshniki",
    storageBucket: "moshniki.firebasestorage.app",
    messagingSenderId: "880440316288",
    appId: "1:880440316288:web:23dc9806e2a6f3ce06b165",
    measurementId: "G-RC6L5FCXY0"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const analytics = firebase.analytics();
  let userId = null;

  // --- STATE ---
  let template = { 
    income: 0, 
    bills: [],
    payDate: new Date().toISOString().split('T')[0],
    frequency: 'weekly' 
  };
  
  let history = []; 
  let selectedOffset = 0; // 0 = next pay, 1 = pay after that...

  // --- AUTH ---
  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      document.getElementById("authContainer").innerHTML = `
        <div style="font-size:12px; color:var(--text-muted)">Welcome,</div>
        <div style="font-weight:bold; color:white; margin-bottom:10px;">${user.displayName}</div>
        <button class="btn btn-outline" style="padding:6px; font-size:11px;" onclick="firebase.auth().signOut()">Sign Out</button>
      `;
      loadData();
    } else {
      document.getElementById("authContainer").innerHTML = `<button id="authBtn" class="btn btn-google">Sign In with Google</button>`;
      document.getElementById("authBtn").onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      document.getElementById("timelineList").innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted); font-size:13px;">Please sign in to view your budget</div>`;
    }
  });

  // --- CORE LOGIC ---

  function addBill(name="", amount=0, freq="weekly") {
    template.bills.push({ name, amount, freq });
    renderBills();
    saveTemplate(); // Auto-save on add
  }

  // Render the Bill Inputs
  function renderBills() {
    const container = document.getElementById("billContainer");
    container.innerHTML = "";
    
    template.bills.forEach((bill, i) => {
      const div = document.createElement("div");
      div.className = "bill-row";
      div.innerHTML = `
        <input value="${bill.name}" placeholder="Name (e.g. Strata)" onchange="template.bills[${i}].name=this.value; updateCalculations(); saveTemplate()">
        <input type="number" value="${bill.amount}" placeholder="$" onchange="template.bills[${i}].amount=+this.value; updateCalculations(); saveTemplate()">
        <select onchange="template.bills[${i}].freq=this.value; updateCalculations(); saveTemplate()">
          <option value="weekly" ${bill.freq==='weekly'?'selected':''}>Weekly</option>
          <option value="fortnightly" ${bill.freq==='fortnightly'?'selected':''}>Fortnightly</option>
          <option value="monthly" ${bill.freq==='monthly'?'selected':''}>Monthly</option>
          <option value="quarterly" ${bill.freq==='quarterly'?'selected':''}>Quarterly</option>
        </select>
        <button style="color:#ef4444; background:none; border:none; cursor:pointer; font-weight:bold;" onclick="template.bills.splice(${i},1);renderBills();saveTemplate()">✕</button>
      `;
      container.appendChild(div);
    });
    updateCalculations();
  }

  // The "Brains" - Calculate what to save THIS week based on Bill Freq vs Pay Freq
  function updateCalculations() {
    const payFreq = document.getElementById("frequency").value;
    const income = parseFloat(document.getElementById("weekIncome").value) || 0;
    template.income = income;

    let totalRequiredSavings = 0;
    let savingsListHTML = "";

    template.bills.forEach(bill => {
      let costPerPay = 0;
      let note = "";

      // Convert Bill Freq to Annual, then divide by Pay Freq
      const annualCost = getAnnualCost(bill.amount, bill.freq);
      const paysPerYear = payFreq === 'weekly' ? 52 : 26;
      costPerPay = annualCost / paysPerYear;

      // Formatting logic for the "Bill Splitter" Box
      let highlightClass = "";
      if(bill.freq !== payFreq) {
        // If mismatch (e.g. Monthly bill vs Weekly pay), highlight it
        note = `<span style="color:var(--accent)">(Save <b>$${costPerPay.toFixed(2)}</b> / pay)</span>`;
        highlightClass = "color:var(--text-main); font-weight:bold;";
      } else {
        note = `<span style="color:var(--text-muted)">(Pay full amount)</span>`;
        highlightClass = "color:var(--text-muted);";
      }
      
      totalRequiredSavings += costPerPay;
      
      if(costPerPay > 0) {
        savingsListHTML += `
          <div style="display:flex; justify-content:space-between; border-bottom:1px solid #334155; padding-bottom:6px;">
            <span style="${highlightClass}">${bill.name}</span>
            <span>$${costPerPay.toFixed(2)}</span>
          </div>
        `;
      }
    });

    const leftover = income - totalRequiredSavings;

    // Update UI
    document.getElementById("weekLeftover").innerText = "$" + leftover.toFixed(2);
    document.getElementById("weekSavingsReq").innerText = "$" + totalRequiredSavings.toFixed(2);
    document.getElementById("savingsBreakdownList").innerHTML = savingsListHTML || "<div style='color:var(--text-muted)'>No bills added yet.</div>";
    
    updateForecast(totalRequiredSavings);
  }

  function getAnnualCost(amount, freq) {
    if(freq === 'weekly') return amount * 52;
    if(freq === 'fortnightly') return amount * 26;
    if(freq === 'monthly') return amount * 12;
    if(freq === 'quarterly') return amount * 4;
    return 0;
  }

  // Render the Left Sidebar (Timeline)
  function renderTimeline() {
    const list = document.getElementById("timelineList");
    list.innerHTML = "";
    
    const startStr = document.getElementById("payDate").value;
    if(!startStr) return;

    const startDate = new Date(startStr);
    const freq = document.getElementById("frequency").value;
    const daysToAdd = freq === 'weekly' ? 7 : 14;

    for(let i=0; i<12; i++) {
      let d = new Date(startDate);
      d.setDate(startDate.getDate() + (i * daysToAdd));
      
      const dateStr = d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
      
      const div = document.createElement("div");
      div.className = `timeline-item ${i === selectedOffset ? 'active' : ''}`;
      div.innerHTML = `<span>Week ${i+1}</span> <span>${dateStr}</span>`;
      div.onclick = () => {
        selectedOffset = i;
        renderTimeline(); // re-render to update active class
        document.getElementById("viewTitle").innerText = i===0 ? "Current Pay" : `Future: ${dateStr}`;
        document.getElementById("currentDateLabel").innerText = dateStr;
        updateCalculations();
      };
      list.appendChild(div);
    }
    
    // Set initial Label
    if(selectedOffset === 0) {
        const d = new Date(startDate);
        const s = d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        document.getElementById("viewTitle").innerText = "Current Pay: " + s;
        document.getElementById("currentDateLabel").innerText = s;
    }
  }

  // Forecast Logic
  function updateForecast(weeklySavings) {
    const historyTotal = history.reduce((acc, week) => acc + (week.saved || 0), 0);
    const futureAccumulation = weeklySavings * (selectedOffset + 1);
    const total = historyTotal + futureAccumulation;

    document.getElementById("accumulatedSavings").innerText = "$" + total.toFixed(2);
  }

  // Complete Week Logic
  function completeWeek() {
    if(!confirm("Mark this week as done? This will save your totals to history and cannot be undone easily.")) return;
    
    const income = template.income;
    const payFreq = document.getElementById("frequency").value;

    // Find Strata specific bills (case insensitive)
    const strataBill = template.bills.find(b => b.name.toLowerCase().includes('strata'));
    let strataPaidAmount = 0;
    
    if(strataBill) {
        // Calculate the theoretical amount contributed to strata this week
        const annual = getAnnualCost(strataBill.amount, strataBill.freq);
        const paysPerYear = payFreq === 'weekly' ? 52 : 26;
        strataPaidAmount = annual / paysPerYear;
    }

    const saved = parseFloat(document.getElementById("weekSavingsReq").innerText.replace('$',''));

    // Save to History
    const entry = {
      date: new Date().toISOString(),
      income: income,
      saved: saved,
      paidStrata: strataPaidAmount
    };

    if(userId) {
      db.collection("users").doc(userId).collection("history").add(entry).then(() => {
        alert("Week saved! Check the sidebar for updated totals.");
        loadHistory();
      });
    }
  }

  // Save/Load
  function saveTemplate() {
    if(!userId) return;
    template.payDate = document.getElementById("payDate").value;
    template.frequency = document.getElementById("frequency").value;
    template.income = parseFloat(document.getElementById("weekIncome").value);
    // Debounce simple save
    db.collection("users").doc(userId).set(template, { merge: true });
  }

  function loadData() {
    // Load Template
    db.collection("users").doc(userId).get().then(doc => {
      if(doc.exists) {
        const d = doc.data();
        if(d.bills) template.bills = d.bills;
        if(d.payDate) template.payDate = d.payDate;
        if(d.frequency) template.frequency = d.frequency;
        if(d.income) template.income = d.income;

        document.getElementById("weekIncome").value = template.income || 0;
        document.getElementById("payDate").value = template.payDate;
        document.getElementById("frequency").value = template.frequency;
        renderBills();
        renderTimeline();
      } else {
        // Init new user
        saveTemplate();
        renderTimeline();
      }
    });
    loadHistory();
  }

  function loadHistory() {
    db.collection("users").doc(userId).collection("history").get().then(snap => {
      history = [];
      let totalStrata = 0;
      let totalSaved = 0;
      
      snap.forEach(doc => {
        const data = doc.data();
        history.push(data);
        if(data.paidStrata) totalStrata += data.paidStrata; 
        totalSaved += (data.saved || 0);
      });

      document.getElementById("histStrata").innerText = "$" + totalStrata.toFixed(0);
      document.getElementById("histSaved").innerText = "$" + totalSaved.toFixed(0);
      updateCalculations(); // Update forecast with new history
    });
  }

</script>
</body>
</html>
