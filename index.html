<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moshniki’s Pro Budget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --accent: #38bdf8;
      --danger: #ef4444;
      --text: #f1f5f9;
      --muted: #94a3b8;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      height: 100vh;
    }

    /* Sidebar */
    aside {
      background: #020617;
      padding: 24px;
      border-right: 1px solid #334155;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h1 { margin: 0; font-size: 20px; background: linear-gradient(90deg, #38bdf8, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .user-profile { font-size: 14px; color: var(--muted); margin-top: auto; }

    button {
      background: var(--accent);
      border: none;
      padding: 12px;
      border-radius: 8px;
      color: #0f172a;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:hover { opacity: 0.9; }
    button.ghost { background: transparent; color: var(--muted); border: 1px solid #334155; }
    button.icon-btn { padding: 8px; background: #33415511; color: var(--danger); }

    /* Main Area */
    main { padding: 30px; overflow-y: auto; }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #334155;
    }
    .stat-card h3 { margin: 0 0 8px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
    .stat-card .value { font-size: 24px; font-weight: 700; }
    .stat-card .sub-text { font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* Layouts */
    .content-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .panel {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid #334155;
    }

    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .panel h2 { margin: 0; font-size: 18px; }

    /* Form Elements */
    input, select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #0f172a;
      color: white;
      box-sizing: border-box;
      margin-bottom: 12px;
    }
    input:focus, select:focus { outline: 2px solid var(--accent); border-color: transparent; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }

    /* Bill List */
    .bill-list { display: flex; flex-direction: column; gap: 10px; }
    .bill-row {
      display: grid;
      grid-template-columns: 1fr 100px 100px 40px;
      gap: 10px;
      align-items: center;
      background: #0f172a55;
      padding: 8px;
      border-radius: 8px;
    }
    
    .chart-container { position: relative; height: 200px; width: 100%; display: flex; justify-content: center; }

    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
      aside { display: none; } /* Simplified for mobile */
      .dashboard-grid { grid-template-columns: 1fr 1fr; }
      .content-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<div class="app">
  <aside>
    <div>
      <h1>Moshniki Pro</h1>
      <p style="color:var(--muted); font-size:13px;">Advanced Budgeting</p>
    </div>
    <button id="authBtn">Sign in with Google</button>
    <div id="userInfo" class="user-profile"></div>
  </aside>

  <main>
    <div class="dashboard-grid">
      <div class="stat-card">
        <h3>Income (Per Pay)</h3>
        <div class="value" id="incomeTotal">$0</div>
        <div class="sub-text" id="payFreqLabel">Weekly</div>
      </div>
      <div class="stat-card">
        <h3>Bills (Per Pay)</h3>
        <div class="value" id="billsTotal">$0</div>
        <div class="sub-text">Normalized cost</div>
      </div>
      <div class="stat-card">
        <h3>Savings</h3>
        <div class="value" id="savingsTotal">$0</div>
        <div class="sub-text">Goal per pay</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #059669, #047857);">
        <h3 style="color:#a7f3d0">Safe to Spend</h3>
        <div class="value" id="leftoverTotal">$0</div>
        <div class="sub-text" style="color:#a7f3d0">Cash for the week</div>
      </div>
    </div>

    <div class="content-layout">
      
      <div style="display:flex; flex-direction:column; gap:24px;">
        <div class="panel">
          <div class="panel-header">
            <h2>Recurring Expenses</h2>
            <button class="ghost" onclick="addBill()" style="padding:6px 12px; font-size:12px;">+ Add Expense</button>
          </div>
          
          <div class="bill-list" id="bills"></div>
          
          <div style="margin-top: 20px; font-size: 13px; color: var(--muted); font-style: italic;">
            * Logic: If you pay Rent monthly but get paid weekly, we calculate how much you need to set aside per week.
          </div>
        </div>

        <div class="panel">
          <div class="panel-header"><h2>Spending Breakdown</h2></div>
          <div class="chart-container">
            <canvas id="budgetChart"></canvas>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header"><h2>Income Settings</h2></div>

        <label>Next Pay Date</label>
        <input type="date" id="payDate" onchange="calculateNextPay()"/>
        <div id="nextPayText" style="margin-bottom:12px; font-size:13px; color:var(--accent)"></div>

        <label>How often do you get paid?</label>
        <select id="frequency" onchange="updateTotals()">
          <option value="52">Weekly (52/yr)</option>
          <option value="26">Fortnightly (26/yr)</option>
          <option value="12">Monthly (12/yr)</option>
        </select>

        <label>Net Pay (Take home)</label>
        <input type="number" id="income" placeholder="0.00"/>

        <label>Savings Goal (Per Pay)</label>
        <input type="number" id="savings" placeholder="0.00"/>

        <button style="width:100%; margin-top:12px" onclick="saveBudget()">Save Changes</button>
      </div>
    </div>
  </main>
</div>

<script>
  // --- CONFIGURATION ---
  // REPLACE WITH YOUR REAL FIREBASE KEYS
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  // --- INIT ---
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let userId = null;
  let chartInstance = null;

  // Data State
  let bills = [];

  // --- AUTHENTICATION ---
  auth.onAuthStateChanged(user => {
    if (!user) {
        document.getElementById("userInfo").innerText = "";
        return;
    }
    userId = user.uid;
    document.getElementById("authBtn").style.display = 'none';
    document.getElementById("userInfo").innerText = "Logged in as " + user.displayName;
    loadBudget();
  });

  document.getElementById("authBtn").onclick = () => {
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  };

  // --- LOGIC: FREQUENCY NORMALIZATION ---
  // We convert everything to an ANNUAL amount, then divide by the Pay Frequency.
  // This is the most accurate way to budget.
  function getAnnualMultiplier(freqValue) {
      return parseInt(freqValue) || 52;
  }

  function addBill(name = "New Bill", amount = 0, freq = "12") {
    bills.push({ name, amount, freq }); // Default freq 12 = Monthly
    renderBills();
  }

  function renderBills() {
    const container = document.getElementById("bills");
    container.innerHTML = "";
    
    bills.forEach((b, i) => {
      const row = document.createElement("div");
      row.className = "bill-row";
      
      // We calculate the "Per Pay" cost for display
      const annualCost = b.amount * b.freq;
      const payFreq = parseInt(document.getElementById("frequency").value);
      const costPerPay = (annualCost / payFreq).toFixed(2);

      row.innerHTML = `
        <input value="${b.name}" placeholder="Bill Name" onchange="bills[${i}].name=this.value; updateChart()">
        
        <input type="number" value="${b.amount}" placeholder="$" onchange="bills[${i}].amount=+this.value; updateTotals()">
        
        <select onchange="bills[${i}].freq=this.value; updateTotals()">
           <option value="52" ${b.freq == 52 ? 'selected' : ''}>Weekly</option>
           <option value="12" ${b.freq == 12 ? 'selected' : ''}>Monthly</option>
           <option value="4" ${b.freq == 4 ? 'selected' : ''}>Quarterly</option>
           <option value="1" ${b.freq == 1 ? 'selected' : ''}>Yearly</option>
        </select>
        
        <button class="icon-btn" onclick="bills.splice(${i},1);renderBills()">×</button>
      `;
      container.appendChild(row);
    });
    updateTotals();
  }

  function updateTotals() {
    const income = +document.getElementById("income").value || 0;
    const savings = +document.getElementById("savings").value || 0;
    const payFreq = parseInt(document.getElementById("frequency").value);
    
    // Update Frequency Label
    const freqMap = { '52': 'Weekly', '26': 'Fortnightly', '12': 'Monthly' };
    document.getElementById("payFreqLabel").innerText = freqMap[payFreq];

    // Calculate Normalized Bill Total
    let totalBillsPerPay = 0;
    bills.forEach(b => {
        const annual = b.amount * parseInt(b.freq);
        totalBillsPerPay += (annual / payFreq);
    });

    const leftover = income - totalBillsPerPay - savings;

    // Render Text
    document.getElementById("incomeTotal").innerText = formatCurrency(income);
    document.getElementById("billsTotal").innerText = formatCurrency(totalBillsPerPay);
    document.getElementById("savingsTotal").innerText = formatCurrency(savings);
    document.getElementById("leftoverTotal").innerText = formatCurrency(leftover);

    // Update Chart
    renderChart(income, totalBillsPerPay, savings, leftover);
    calculateNextPay();
  }

  function formatCurrency(num) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
  }

  // --- CHARTS ---
  function renderChart(income, bills, savings, leftover) {
    const ctx = document.getElementById('budgetChart');
    const data = [bills, savings, leftover > 0 ? leftover : 0];
    
    if (chartInstance) {
        chartInstance.data.datasets[0].data = data;
        chartInstance.update();
    } else {
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Bills', 'Savings', 'Spending Money'],
                datasets: [{
                    data: data,
                    backgroundColor: ['#ef4444', '#38bdf8', '#059669'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#94a3b8' } }
                }
            }
        });
    }
  }

  // --- UX HELPERS ---
  function calculateNextPay() {
      const dateVal = document.getElementById("payDate").value;
      if (!dateVal) return;
      
      const lastPay = new Date(dateVal);
      const today = new Date();
      const payFreq = parseInt(document.getElementById("frequency").value);
      
      // Rough calc for demo logic
      let daysToAdd = 7; 
      if(payFreq === 26) daysToAdd = 14;
      if(payFreq === 12) daysToAdd = 30;

      // Find next date in future
      let nextDate = new Date(lastPay);
      while(nextDate < today) {
          nextDate.setDate(nextDate.getDate() + daysToAdd);
      }
      
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById("nextPayText").innerText = "Next Pay: " + nextDate.toLocaleDateString("en-US", options);
  }

  const incomeInput = document.getElementById("income");
  const savingsInput = document.getElementById("savings");
  incomeInput.oninput = savingsInput.oninput = updateTotals;

  // --- FIREBASE SAVE/LOAD ---
  function saveBudget() {
    if (!userId) return alert("Please sign in first!");
    const btn = document.querySelector("button[onclick='saveBudget()']");
    const originalText = btn.innerText;
    btn.innerText = "Saving...";
    
    db.collection("users").doc(userId).set({
      payDate: document.getElementById("payDate").value,
      frequency: document.getElementById("frequency").value,
      income: +incomeInput.value,
      savings: +savingsInput.value,
      bills
    }).then(() => {
        btn.innerText = "Saved!";
        setTimeout(() => btn.innerText = originalText, 1500);
    });
  }

  function loadBudget() {
    db.collection("users").doc(userId).get().then(doc => {
      if (!doc.exists) return;
      const d = doc.data();
      document.getElementById("payDate").value = d.payDate || "";
      document.getElementById("frequency").value = d.frequency || "52";
      incomeInput.value = d.income || 0;
      savingsInput.value = d.savings || 0;
      bills = d.bills || [];
      renderBills();
    });
  }
</script>
</body>
</html>
