<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Reylo | Operations Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020203;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.6);
            --danger: #ef4444;
            --success: #10b981;
            --text: #ffffff;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Space Grotesk', sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        /* LIVE INDICATOR */
        .live-dot {
            display: inline-block; width: 8px; height: 8px; background-color: var(--success);
            border-radius: 50%; margin-left: 12px; box-shadow: 0 0 10px var(--success);
            animation: blink 2s infinite; vertical-align: middle;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* LOGIN */
        #login-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            backdrop-filter: blur(20px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .pin-input {
            padding: 15px; font-size: 1.5rem; text-align: center; letter-spacing: 5px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--accent); color: white; border-radius: 12px;
            width: 200px; margin-bottom: 20px;
        }
        .enter-btn {
            padding: 12px 30px; background: var(--accent); border: none; color: white;
            font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.3s;
        }

        /* DASHBOARD */
        .container {
            width: 100%; max-width: 1200px; display: none; animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
            padding: 30px; background: rgba(10, 10, 16, 0.6); 
            border: 1px solid rgba(255,255,255,0.1); border-top: 1px solid rgba(255,255,255,0.4);
            border-radius: 24px; margin-bottom: 30px;
            backdrop-filter: blur(40px);
        }
        
        .logo { font-size: 1.8rem; font-weight: 700; letter-spacing: 1px; line-height: 1; }
        .logo span { color: var(--accent); }
        .subtitle {
            font-size: 0.85rem; color: #666; margin-top: 8px; letter-spacing: 1px; text-transform: uppercase; font-weight: 600;
        }

        .admin-search {
            padding: 12px 20px; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            color: white; border-radius: 12px; width: 280px; font-size: 0.95rem;
            transition: 0.3s;
        }
        .admin-search:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }

        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn {
            padding: 10px 20px; background: rgba(0,0,0,0.4); border: 1px solid var(--border);
            color: #aaa; border-radius: 30px; cursor: pointer; transition: 0.2s; font-weight: 600; font-size: 0.9rem;
        }
        .tab-btn:hover { color: white; border-color: white; }
        .tab-btn.active { 
            background: rgba(59, 130, 246, 0.2); color: white; border-color: var(--accent); 
        }

        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 25px;
        }

        .card {
            background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; overflow: hidden;
            display: flex; flex-direction: column; transition: 0.3s;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }

        .card-body { display: flex; padding: 20px; gap: 20px; }
        .poster {
            width: 180px; height: 270px; object-fit: cover; border-radius: 12px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.6); flex-shrink: 0;
        }
        .info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        
        .title { font-weight: 700; font-size: 1.4rem; margin-bottom: 5px; line-height: 1.2; }
        .year { font-size: 1rem; color: var(--accent); font-weight: 600; margin-bottom: 8px; display: block;}
        .genre-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px; }
        .tag { font-size: 0.75rem; padding: 3px 10px; border-radius: 10px; background: rgba(255,255,255,0.1); color: #ccc; }
        .plot { font-size: 0.9rem; color: #999; line-height: 1.5; -webkit-line-clamp: 5; overflow: hidden; margin-bottom: 15px;}
        .client-info { font-size: 0.85rem; color: #666; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); }

        .details-box { padding: 15px 20px; background: rgba(59, 130, 246, 0.05); font-size: 0.9rem; color: #ddd; font-style: italic; }

        .actions {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); margin-top: auto;
        }
        .imdb-link { color: #f5c518; text-decoration: none; font-weight: bold; }
        
        .btn-complete {
            background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid var(--success);
            padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .btn-complete:hover { background: var(--success); color: black; }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger);
            padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .btn-delete:hover { background: var(--danger); color: white; }

        /* MOBILE FIXES */
        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; }
            .grid { grid-template-columns: 1fr; }
            .admin-search { width: 100%; }
            .card-body { flex-direction: column; align-items: center; text-align: center; }
            .poster { width: 200px; height: 300px; margin-bottom: 10px; }
            .actions { justify-content: center; gap:10px; }
        }
    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <div id="login-gate">
        <div style="margin-bottom:20px; color:#666; letter-spacing:2px;">SECURE ACCESS</div>
        <input type="password" id="pin-input" class="pin-input" placeholder="PIN">
        <button onclick="checkPin()" class="enter-btn">ENTER SYSTEM</button>
    </div>

    <div class="container" id="dashboard">
     <div class="header">
            <div class="logo">REYLO <span>STREAMING</span></div>
            <p style="color:var(--text-muted); font-size:1rem; margin-top:8px; letter-spacing: 1px;">VOD Request & Reporting Centre</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchView('active')">Active Requests</button>
            <button class="tab-btn" onclick="switchView('completed')">History / Completed</button>
            <button class="tab-btn" onclick="switchView('reports')">Issue Reports</button>
        </div>

        <div id="content-grid" class="grid"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDJlsmsRNuIVDOIrgdRyaSClqXsLj94MB0",
          projectId: "vodrequest",
          appId: "1:603036227000:web:340e481b47eb70cc742b4d",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentView = 'active'; 
        let refreshInterval;

        window.checkPin = function() {
            if(document.getElementById('pin-input').value === "2024") {
                document.getElementById('login-gate').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
                // Auto Refresh Every 15s
                refreshInterval = setInterval(() => loadData(true), 15000); 
            } else { alert("ACCESS DENIED"); }
        }

        window.switchView = function(view) {
            currentView = view;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadData();
        }

        window.loadData = async function(isBackgroundRefresh = false) {
            const grid = document.getElementById('content-grid');
            
            if(!isBackgroundRefresh) {
                grid.innerHTML = '<div style="color:#666; padding:20px;">Fetching records...</div>';
            }
            
            try {
                let collectionName = currentView === 'reports' ? 'reports' : 'requests';
                const q = query(collection(db, collectionName), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                grid.innerHTML = '';
                let count = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const id = doc.id;
                    const status = data.status || 'New';

                    if(currentView === 'active' && status === 'Completed') return; 
                    if(currentView === 'completed' && status !== 'Completed') return; 

                    if(collectionName === 'requests') createRequestCard(id, data, currentView === 'completed');
                    else createReportCard(id, data);
                    count++;
                });

                if(count === 0) grid.innerHTML = '<div style="color:#444; padding:20px;">No records found in this view.</div>';

                const currentSearch = document.querySelector('.admin-search').value;
                if(currentSearch) filterCards(currentSearch);

            } catch (error) {
                console.error(error);
                if(error.message.includes("index")) {
                    const q2 = query(collection(db, currentView === 'reports' ? 'reports' : 'requests'));
                    const snap2 = await getDocs(q2);
                    grid.innerHTML = '';
                    snap2.forEach(doc => {
                        const data = doc.data();
                        const status = data.status || 'New';
                        if(currentView === 'active' && status !== 'Completed') createRequestCard(doc.id, data, false);
                        else if(currentView === 'completed' && status === 'Completed') createRequestCard(doc.id, data, true);
                        else if(currentView === 'reports') createReportCard(doc.id, data);
                    });
                }
            }
        }

        function createRequestCard(id, data, isCompletedTab) {
            const grid = document.getElementById('content-grid');
            const posterUrl = data.Poster_URL && data.Poster_URL !== "N/A" ? data.Poster_URL : "https://via.placeholder.com/180x270?text=No+Img";
            
            let genreHtml = '';
            if(data.Genre) data.Genre.split(',').slice(0,3).forEach(g => genreHtml += `<span class="tag">${g.trim()}</span>`);

            let btnHtml = '';
            if(isCompletedTab) {
                btnHtml = `<button onclick="deleteItem('${id}', 'requests')" class="btn-delete">Delete Forever üóëÔ∏è</button>`;
            } else {
                btnHtml = `<button onclick="markComplete('${id}')" class="btn-complete">Mark Complete ‚úì</button>`;
            }

            const html = `
                <div class="card" id="card-${id}">
                    <div class="card-body">
                        <img src="${posterUrl}" class="poster">
                        <div class="info">
                            <div class="title">${data.Confirmed_Title || data.Search_Query || "Unknown"}</div>
                            <span class="year">${data.Year || ""}</span>
                            <div class="genre-tags">${genreHtml}</div>
                            <div class="plot">${data.Plot || "No plot info available."}</div>
                            <div class="client-info">Requested by: <span style="color:#fff;">${data.Client_Name}</span></div>
                        </div>
                    </div>
                    ${data.Request_Details ? `<div class="details-box">" ${data.Request_Details} "</div>` : ''}
                    <div class="actions">
                        ${data.IMDB_Link ? `<a href="${data.IMDB_Link}" target="_blank" class="imdb-link">IMDB ‚Üó</a>` : '<span></span>'}
                        ${btnHtml}
                    </div>
                </div>
            `;
            grid.innerHTML += html;
        }

        function createReportCard(id, data) {
            const grid = document.getElementById('content-grid');
            const html = `
                <div class="card" id="card-${id}" style="border-left: 4px solid #ef4444;">
                    <div class="card-body" style="flex-direction:column; gap:10px;">
                        <div style="display:flex; justify-content:space-between;">
                            <span style="color:#ef4444; font-weight:bold;">${data.Issue_Type}</span>
                            <span style="font-size:0.8rem; color:#666;">${data.Source}</span>
                        </div>
                        <div class="title">${data.Channel_Name}</div>
                        <div style="font-size:0.9rem; color:#aaa;">${data.Category}</div>
                        <div class="client-info">By: <span style="color:#fff;">${data.Client_Email || "Anon"}</span></div>
                    </div>
                    <div class="details-box">${data.Description || "No details."}</div>
                    <div class="actions" style="justify-content:flex-end;">
                        <button onclick="deleteItem('${id}', 'reports')" class="btn-delete">Resolve & Delete</button>
                    </div>
                </div>
            `;
            grid.innerHTML += html;
        }

        window.markComplete = async function(id) {
            if(!confirm("Mark this request as completed? It will move to History.")) return;
            try {
                await updateDoc(doc(db, "requests", id), { status: "Completed" });
                loadData(true); 
            } catch (error) { alert("Error: " + error.message); }
        }

        window.deleteItem = async function(id, collectionName) {
            if(!confirm("Delete this record permanently?")) return;
            try {
                await deleteDoc(doc(db, collectionName, id));
                loadData(true); 
            } catch (error) { alert("Error: " + error.message); }
        }

        window.filterCards = function(text) {
            const search = text.toLowerCase();
            document.querySelectorAll('.card').forEach(card => {
                const txt = card.innerText.toLowerCase();
                card.style.display = txt.includes(search) ? 'flex' : 'none';
            });
        }

        const canvas = document.getElementById("particle-canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        class P { constructor(){this.x=Math.random()*canvas.width;this.y=Math.random()*canvas.height;this.vx=Math.random()*0.5-0.25;this.vy=Math.random()*0.5-0.25;this.s=Math.random()*2} update(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>canvas.width)this.vx*=-1;if(this.y<0||this.y>canvas.height)this.vy*=-1} draw(){ctx.fillStyle='rgba(59,130,246,0.2)';ctx.beginPath();ctx.arc(this.x,this.y,this.s,0,Math.PI*2);ctx.fill()}}
        function loop(){ctx.clearRect(0,0,canvas.width,canvas.height);particles.forEach(p=>{p.update();p.draw()});requestAnimationFrame(loop)}
        for(let i=0;i<60;i++)particles.push(new P()); loop();
    </script>
</body>
</html>
