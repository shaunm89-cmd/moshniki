<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moshniki Simple Budget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #111827;
      --card: #1f2937;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --green: #10b981;
      --red: #ef4444;
    }

    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; }

    /* --- SIDEBAR (Weeks) --- */
    aside { width: 220px; background: #0f172a; border-right: 1px solid #374151; display: flex; flex-direction: column; }
    
    .logo { padding: 20px; font-weight: 800; color: var(--accent); letter-spacing: -1px; }
    
    .timeline { flex: 1; overflow-y: auto; padding: 10px; }
    .week-item {
      padding: 12px 16px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; color: var(--muted); font-size: 14px;
      display: flex; justify-content: space-between;
    }
    .week-item:hover { background: #1e293b; color: white; }
    .week-item.active { background: var(--accent); color: white; font-weight: 600; }
    
    .history-box { padding: 20px; border-top: 1px solid #374151; background: #0b0f19; font-size: 13px; }

    /* --- MAIN --- */
    main { flex: 1; padding: 40px; overflow-y: auto; max-width: 900px; margin: 0 auto; }

    /* HERO SECTION */
    .hero-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
    
    .hero-card { background: var(--card); padding: 25px; border-radius: 16px; text-align: center; border: 1px solid #374151; }
    .hero-card.main { border: 2px solid var(--green); background: #064e3b33; }
    
    .hero-label { font-size: 13px; text-transform: uppercase; color: var(--muted); letter-spacing: 1px; margin-bottom: 10px; }
    .hero-value { font-size: 36px; font-weight: 800; }
    
    /* INPUT SECTION */
    .input-group { margin-bottom: 30px; }
    .input-label { display: block; color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .main-input { background: var(--bg); border: 1px solid #374151; color: white; padding: 12px; font-size: 16px; border-radius: 8px; width: 100%; box-sizing: border-box; }

    /* BILL LIST */
    .bill-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #374151; padding-bottom: 10px; }
    .bill-row { 
      display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; 
      padding: 12px; background: var(--card); border-radius: 8px; margin-bottom: 8px; align-items: center; 
    }
    
    .bill-input { background: transparent; border: none; color: white; font-size: 14px; width: 100%; }
    .bill-input:focus { outline: none; border-bottom: 1px solid var(--accent); }
    
    select { background: #111827; border: 1px solid #374151; color: white; padding: 5px; border-radius: 4px; }

    /* BUTTONS */
    .btn { width: 100%; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; font-size: 15px; transition: 0.2s; }
    .btn-primary { background: var(--green); color: white; margin-top: 30px; }
    .btn-secondary { background: var(--card); color: var(--muted); border: 1px solid #374151; width: auto; padding: 8px 16px; font-size: 13px; }
    .btn-del { color: var(--red); background: transparent; cursor: pointer; font-weight: bold; border: none; }

    @media(max-width: 800px) {
      body { flex-direction: column; }
      aside { width: 100%; height: auto; flex-direction: row; overflow-x: auto; }
      .hero-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<aside>
  <div class="logo">Moshniki</div>
  <div class="timeline" id="weekList">
    </div>
  <div class="history-box">
    <div style="margin-bottom:6px; color:#9ca3af">LIFETIME STRATA PAID</div>
    <div id="histStrata" style="font-size:20px; font-weight:bold; color:var(--accent)">$0</div>
    <button id="authBtn" style="margin-top:15px; background:none; border:none; color:#6b7280; text-decoration:underline; cursor:pointer;">Sign In</button>
  </div>
</aside>

<main>
  
  <div class="input-group">
    <label class="input-label">TOTAL INCOME THIS WEEK</label>
    <input type="number" id="income" class="main-input" value="0" placeholder="$0.00">
  </div>

  <div class="hero-grid">
    <div class="hero-card">
      <div class="hero-label">Transfer to Bills Account</div>
      <div class="hero-value" style="color:var(--red)" id="totalBills">$0</div>
      <div style="font-size:12px; color:var(--muted); margin-top:8px;">Cover all future bills</div>
    </div>

    <div class="hero-card main">
      <div class="hero-label">Safe To Spend</div>
      <div class="hero-value" style="color:var(--green)" id="safeSpend">$0</div>
      <div style="font-size:12px; color:var(--green); margin-top:8px;">Groceries, fun, fuel</div>
    </div>
  </div>

  <div class="bill-list-header">
    <h3>Your Bills</h3>
    <button class="btn-secondary" onclick="addBill()">+ Add Bill</button>
  </div>
  <div style="font-size:12px; color:#6b7280; margin-bottom:15px;">
    Tip: Add monthly bills (like Optus $190) and select "Monthly". We automatically calculate the weekly set-aside amount.
  </div>

  <div id="billsContainer"></div>

  <button class="btn btn-primary" onclick="completeWeek()">✔ Mark Week Complete</button>

  <div style="margin-top: 40px; border-top: 1px solid #374151; padding-top: 20px;">
    <label class="input-label">Settings: Next Pay Date</label>
    <input type="date" id="payDate" style="background:#1f2937; border:none; color:white; padding:8px; border-radius:6px;" onchange="renderWeeks()">
  </div>

</main>

<script>
  // --- CONFIG (PLUG YOUR KEYS IN) ---
  const firebaseConfig = {
    apiKey: "AIzaSyA5No9QeHpYwJDblMFat_cK2gyVm_K1RtE",
    authDomain: "moshniki.firebaseapp.com",
    projectId: "moshniki",
    storageBucket: "moshniki.firebasestorage.app",
    messagingSenderId: "880440316288",
    appId: "1:880440316288:web:23dc9806e2a6f3ce06b165"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let userId = null;
  
  let data = {
    income: 0,
    bills: [],
    payDate: new Date().toISOString().split('T')[0]
  };

  // --- AUTH ---
  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      document.getElementById("authBtn").innerText = "Sign Out";
      document.getElementById("authBtn").onclick = () => auth.signOut();
      loadData();
    } else {
      document.getElementById("authBtn").innerText = "Sign In with Google";
      document.getElementById("authBtn").onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }
  });

  // --- LOGIC ---
  function addBill() {
    data.bills.push({ name: "", amount: 0, freq: "weekly" });
    renderBills();
  }

  function renderBills() {
    const container = document.getElementById("billsContainer");
    container.innerHTML = "";

    data.bills.forEach((bill, i) => {
      // Calculate weekly cost for display
      let weeklyCost = 0;
      if(bill.freq === 'weekly') weeklyCost = bill.amount;
      if(bill.freq === 'fortnightly') weeklyCost = bill.amount / 2;
      if(bill.freq === 'monthly') weeklyCost = (bill.amount * 12) / 52;
      if(bill.freq === 'quarterly') weeklyCost = (bill.amount * 4) / 52;

      const div = document.createElement("div");
      div.className = "bill-row";
      div.innerHTML = `
        <input class="bill-input" placeholder="Bill Name" value="${bill.name}" onchange="data.bills[${i}].name=this.value; saveData()">
        <input class="bill-input" type="number" placeholder="$0" value="${bill.amount}" onchange="data.bills[${i}].amount=+this.value; renderBills(); saveData()">
        <select onchange="data.bills[${i}].freq=this.value; renderBills(); saveData()">
          <option value="weekly" ${bill.freq=='weekly'?'selected':''}>Weekly</option>
          <option value="fortnightly" ${bill.freq=='fortnightly'?'selected':''}>Fortnightly</option>
          <option value="monthly" ${bill.freq=='monthly'?'selected':''}>Monthly</option>
        </select>
        <button class="btn-del" onclick="data.bills.splice(${i},1); renderBills(); saveData()">×</button>
        
        <div style="grid-column: 1 / -1; font-size: 11px; color: var(--accent); margin-top: -5px;">
           ${bill.freq !== 'weekly' ? `Equivalent to $${weeklyCost.toFixed(2)} / week` : ''}
        </div>
      `;
      container.appendChild(div);
    });
    calcTotals();
  }

  function calcTotals() {
    const income = parseFloat(document.getElementById("income").value) || 0;
    data.income = income;

    // Calculate total WEEKLY bill cost
    let totalWeeklyBills = 0;
    data.bills.forEach(b => {
      let weekly = 0;
      if(b.freq === 'weekly') weekly = b.amount;
      else if(b.freq === 'fortnightly') weekly = b.amount / 2;
      else if(b.freq === 'monthly') weekly = (b.amount * 12) / 52;
      else if(b.freq === 'quarterly') weekly = (b.amount * 4) / 52;
      totalWeeklyBills += weekly;
    });

    const safeSpend = income - totalWeeklyBills;

    document.getElementById("totalBills").innerText = "$" + totalWeeklyBills.toFixed(0);
    document.getElementById("safeSpend").innerText = "$" + safeSpend.toFixed(0);
  }

  document.getElementById("income").oninput = calcTotals;

  // --- TIMELINE & HISTORY ---
  function renderWeeks() {
    const container = document.getElementById("weekList");
    container.innerHTML = "";
    
    const start = new Date(document.getElementById("payDate").value);
    
    for(let i=0; i<10; i++) {
      let d = new Date(start);
      d.setDate(start.getDate() + (i*7));
      
      const div = document.createElement("div");
      div.className = i===0 ? "week-item active" : "week-item";
      div.innerHTML = `<span>Week ${i+1}</span> <span>${d.getDate()}/${d.getMonth()+1}</span>`;
      div.onclick = () => {
        // Just navigation logic if you want to expand features later
        document.querySelectorAll('.week-item').forEach(e => e.classList.remove('active'));
        div.classList.add('active');
      };
      container.appendChild(div);
    }
  }

  function completeWeek() {
    if(!userId) return alert("Sign in to save history");
    if(!confirm("Finish this week? totals will be added to history.")) return;

    // Calculate Strata specifically
    let strataPaid = 0;
    data.bills.forEach(b => {
      if(b.name.toLowerCase().includes("strata")) {
         // Add the WEEKLY equivalent
         if(b.freq === 'weekly') strataPaid += b.amount;
         if(b.freq === 'fortnightly') strataPaid += b.amount/2;
         if(b.freq === 'monthly') strataPaid += (b.amount*12)/52;
      }
    });

    db.collection("users").doc(userId).collection("history").add({
      date: new Date().toISOString(),
      strataPaid: strataPaid
    }).then(() => {
      alert("Week Saved!");
      loadHistory();
    });
  }

  // --- SAVE/LOAD ---
  function saveData() {
    if(!userId) return;
    data.payDate = document.getElementById("payDate").value;
    db.collection("users").doc(userId).set(data);
    calcTotals();
  }

  function loadData() {
    db.collection("users").doc(userId).get().then(doc => {
      if(doc.exists) {
        let d = doc.data();
        data.bills = d.bills || [];
        data.income = d.income || 0;
        data.payDate = d.payDate || new Date().toISOString().split('T')[0];
        
        document.getElementById("income").value = data.income;
        document.getElementById("payDate").value = data.payDate;
        
        renderBills();
        renderWeeks();
      }
    });
    loadHistory();
  }

  function loadHistory() {
    db.collection("users").doc(userId).collection("history").get().then(snap => {
      let total = 0;
      snap.forEach(d => total += (d.data().strataPaid || 0));
      document.getElementById("histStrata").innerText = "$" + total.toFixed(0);
    });
  }
</script>
</body>
</html>
