<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMR & Intelligence Portal</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --border: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            height: 100vh;
        }

        /* Sidebar Navigation */
        nav {
            width: 250px;
            background-color: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        nav h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid var(--dark); padding-bottom: 15px; }

        .nav-btn {
            background: none;
            border: none;
            color: var(--light);
            padding: 15px;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .nav-btn:hover, .nav-btn.active {
            background-color: var(--dark);
            color: white;
            font-weight: bold;
        }

        /* Main Content Area */
        main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1 { border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px; margin-top: 0; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea { resize: vertical; height: 100px; }

        .row { display: flex; gap: 20px; }
        .col { flex: 1; }

        button.primary-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
        }

        button.primary-btn:hover { background-color: #c0392b; }

        /* Associates Section */
        .associate-box {
            background: white;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-top: 10px;
        }
        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .tag {
            background-color: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tag span { cursor: pointer; font-weight: bold; }

        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--light); }
        th { background-color: var(--dark); color: white; }
        tr:hover { background-color: #f1f1f1; }

        /* Connection Visualizer */
        .network-card {
            background: white;
            border-left: 5px solid var(--accent);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .network-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .connection-line {
            padding-left: 20px;
            border-left: 2px dashed var(--border);
            margin-left: 10px;
        }
        .linked-person {
            background: #e8f6f3;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            color: #16a085;
            font-weight: bold;
        }

    </style>
</head>
<body>

<nav>
    <h2>Compliance Portal</h2>
    <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
    <button class="nav-btn" onclick="showSection('new-report')">New SMR / Incident</button>
    <button class="nav-btn" onclick="showSection('connections')">Entity Connections</button>
</nav>

<main>
    <div id="dashboard" class="section active">
        <h1>Recent Reports</h1>
        <div id="reports-list">
            <p style="color: #7f8c8d;">No reports filed yet.</p>
        </div>
    </div>

    <div id="new-report" class="section">
        <h1>Submit SMR / Incident</h1>
        <form id="smrForm" onsubmit="submitReport(event)">
            
            <h3>Subject (POI) Details</h3>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="poiName" required placeholder="e.g. John Doe">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="poiDob">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>ID Type / Number</label>
                        <input type="text" id="poiId" placeholder="Drivers License / Member ID">
                    </div>
                </div>
            </div>

            <h3>Incident Details</h3>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Date & Time</label>
                        <input type="datetime-local" id="incidentTime" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Nature of Activity</label>
                        <select id="incidentType">
                            <option>Structuring / Cash Threshold</option>
                            <option>Use of False ID</option>
                            <option>Money Laundering Suspicion</option>
                            <option>Unexplained Wealth</option>
                            <option>General Suspicious Behavior</option>
                            <option>Barring / Exclusion Breach</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Narrative / Observation</label>
                <textarea id="narrative" placeholder="Describe the behavior details..."></textarea>
            </div>

            <div class="associate-box">
                <label>Associates Present (Connect POIs)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="associateInput" placeholder="Enter associate name">
                    <button type="button" class="primary-btn" onclick="addAssociate()" style="padding: 5px 15px;">Add</button>
                </div>
                <div class="tag-container" id="associateTags"></div>
            </div>

            <br>
            <button type="submit" class="primary-btn">Submit Report</button>
        </form>
    </div>

    <div id="connections" class="section">
        <h1>Intelligence Database</h1>
        <div class="form-group">
            <input type="text" id="searchEntity" placeholder="Search for a Name (POI or Associate)..." onkeyup="searchConnections()">
        </div>
        <div id="connectionResults"></div>
    </div>
</main>

<script>
    // --- STATE MANAGEMENT ---
    let reports = JSON.parse(localStorage.getItem('smr_reports')) || [];
    let currentAssociates = [];

    // --- NAVIGATION ---
    function showSection(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(id).classList.add('active');
        // Highlight button
        const buttons = document.querySelectorAll('.nav-btn');
        if(id === 'dashboard') buttons[0].classList.add('active');
        if(id === 'new-report') buttons[1].classList.add('active');
        if(id === 'connections') buttons[2].classList.add('active');

        if(id === 'dashboard') renderDashboard();
    }

    // --- FORM LOGIC ---
    function addAssociate() {
        const input = document.getElementById('associateInput');
        const name = input.value.trim();
        if (name && !currentAssociates.includes(name)) {
            currentAssociates.push(name);
            renderAssociates();
        }
        input.value = '';
    }

    function removeAssociate(name) {
        currentAssociates = currentAssociates.filter(a => a !== name);
        renderAssociates();
    }

    function renderAssociates() {
        const container = document.getElementById('associateTags');
        container.innerHTML = currentAssociates.map(name => `
            <div class="tag">
                ${name} <span onclick="removeAssociate('${name}')">&times;</span>
            </div>
        `).join('');
    }

    function submitReport(e) {
        e.preventDefault();

        const newReport = {
            id: Date.now(),
            poiName: document.getElementById('poiName').value.trim(),
            poiDob: document.getElementById('poiDob').value,
            poiId: document.getElementById('poiId').value,
            time: document.getElementById('incidentTime').value,
            type: document.getElementById('incidentType').value,
            narrative: document.getElementById('narrative').value,
            associates: [...currentAssociates]
        };

        reports.unshift(newReport); // Add to top
        localStorage.setItem('smr_reports', JSON.stringify(reports));

        // Reset Form
        document.getElementById('smrForm').reset();
        currentAssociates = [];
        renderAssociates();
        alert('Report Submitted Successfully');
        showSection('dashboard');
    }

    // --- DASHBOARD RENDER ---
    function renderDashboard() {
        const list = document.getElementById('reports-list');
        if (reports.length === 0) {
            list.innerHTML = '<p>No reports found.</p>';
            return;
        }

        let html = '<table><thead><tr><th>Date</th><th>POI</th><th>Type</th><th>Associates</th></tr></thead><tbody>';
        reports.forEach(r => {
            const date = new Date(r.time).toLocaleDateString();
            const assocString = r.associates.length > 0 ? r.associates.join(', ') : '-';
            html += `<tr>
                <td>${date}</td>
                <td><strong>${r.poiName}</strong></td>
                <td>${r.type}</td>
                <td>${assocString}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        list.innerHTML = html;
    }

    // --- CONNECTION INTELLIGENCE LOGIC ---
    function searchConnections() {
        const query = document.getElementById('searchEntity').value.toLowerCase().trim();
        const resultsDiv = document.getElementById('connectionResults');
        
        if (query.length < 2) {
            resultsDiv.innerHTML = '<p>Enter at least 2 characters to search.</p>';
            return;
        }

        // Filter reports where the query matches the POI OR is found in the Associates list
        const matches = reports.filter(r => 
            r.poiName.toLowerCase().includes(query) || 
            r.associates.some(a => a.toLowerCase().includes(query))
        );

        if (matches.length === 0) {
            resultsDiv.innerHTML = '<p>No connections found for this entity.</p>';
            return;
        }

        let html = '';
        matches.forEach(r => {
            // Determine if the searched person is the Main POI or an Associate in this specific report
            const isMainPOI = r.poiName.toLowerCase().includes(query);
            
            // Calculate "Connections" (People linked in this report excluding the search term)
            let connectedPeople = [];
            if (isMainPOI) {
                // If they are the POI, they are connected to all associates
                connectedPeople = r.associates;
            } else {
                // If they are an associate, they are connected to the Main POI and other associates
                connectedPeople = [r.poiName, ...r.associates.filter(a => !a.toLowerCase().includes(query))];
            }

            html += `
            <div class="network-card">
                <div class="network-header">
                    Reported on: ${new Date(r.time).toLocaleDateString()} 
                    <span style="font-weight:normal; font-size:0.9rem; color: #7f8c8d">(${r.type})</span>
                </div>
                <div style="margin-bottom:10px;">
                    <strong>Role in this event:</strong> ${isMainPOI ? 'Primary Subject (POI)' : 'Associate'}
                </div>
                
                ${connectedPeople.length > 0 ? `
                <div class="connection-line">
                    <strong>Directly Linked To:</strong>
                    ${connectedPeople.map(p => `<div class="linked-person">ðŸ”— ${p}</div>`).join('')}
                </div>
                ` : '<div class="connection-line" style="color:#bdc3c7">No other associates listed in this report.</div>'}
                
                <p style="margin-top:10px; font-style: italic; color: #555;">"${r.narrative}"</p>
            </div>
            `;
        });

        resultsDiv.innerHTML = html;
    }

    // Init
    renderDashboard();

</script>

</body>
</html>
